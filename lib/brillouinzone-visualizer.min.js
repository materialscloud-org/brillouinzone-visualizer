// Materials Cloud bands structure widget v0.1.0-beta.4
// https://www.materialscloud.org
// Contributors: [object Object]
// (c) 2021, Released under the MIT License

(THREE=require("three/build/three.module")).OrbitControls=function(e,t){var n,o,i,r,a;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return u.phi},this.getAzimuthalAngle=function(){return u.theta},this.reset=function(){s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),s.dispatchEvent(l),s.update(),h=d.NONE},this.update=(n=new THREE.Vector3,o=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),i=o.clone().inverse(),r=new THREE.Vector3,a=new THREE.Quaternion,function(){var e=s.object.position;return n.copy(e).sub(s.target),n.applyQuaternion(o),u.setFromVector3(n),s.autoRotate&&h===d.NONE&&V(2*Math.PI/60/60*s.autoRotateSpeed),u.theta+=m.theta,u.phi+=m.phi,u.theta=Math.max(s.minAzimuthAngle,Math.min(s.maxAzimuthAngle,u.theta)),u.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,u.phi)),u.makeSafe(),u.radius*=b,u.radius=Math.max(s.minDistance,Math.min(s.maxDistance,u.radius)),s.target.add(f),n.setFromSpherical(u),n.applyQuaternion(i),e.copy(s.target).add(n),s.object.lookAt(s.target),!0===s.enableDamping?(m.theta*=1-s.dampingFactor,m.phi*=1-s.dampingFactor):m.set(0,0,0),b=1,f.set(0,0,0),!!(y||r.distanceToSquared(s.object.position)>E||8*(1-a.dot(s.object.quaternion))>E)&&(s.dispatchEvent(l),r.copy(s.object.position),a.copy(s.object.quaternion),!(y=!1))}),this.dispose=function(){s.domElement.removeEventListener("contextmenu",Y,!1),s.domElement.removeEventListener("mousedown",B,!1),s.domElement.removeEventListener("wheel",U,!1),s.domElement.removeEventListener("touchstart",Z,!1),s.domElement.removeEventListener("touchend",W,!1),s.domElement.removeEventListener("touchmove",I,!1),document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",F,!1),window.removeEventListener("keydown",G,!1)};var s=this,l={type:"change"},c={type:"start"},p={type:"end"},d={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},h=d.NONE,E=1e-6,u=new THREE.Spherical,m=new THREE.Spherical,b=1,f=new THREE.Vector3,y=!1,v=new THREE.Vector2,g=new THREE.Vector2,R=new THREE.Vector2,T=new THREE.Vector2,w=new THREE.Vector2,H=new THREE.Vector2,x=new THREE.Vector2,M=new THREE.Vector2,S=new THREE.Vector2;function O(){return Math.pow(.95,s.zoomSpeed)}function V(e){m.theta-=e}function j(e){m.phi-=e}var C,L,z,A=(C=new THREE.Vector3,function(e,t){C.setFromMatrixColumn(t,0),C.multiplyScalar(-e),f.add(C)}),_=(L=new THREE.Vector3,function(e,t){L.setFromMatrixColumn(t,1),L.multiplyScalar(e),f.add(L)}),k=(z=new THREE.Vector3,function(e,t){var n,o=s.domElement===document?s.domElement.body:s.domElement;s.object instanceof THREE.PerspectiveCamera?(n=s.object.position,z.copy(n).sub(s.target),n=z.length(),n*=Math.tan(s.object.fov/2*Math.PI/180),A(2*e*n/o.clientHeight,s.object.matrix),_(2*t*n/o.clientHeight,s.object.matrix)):s.object instanceof THREE.OrthographicCamera?(A(e*(s.object.right-s.object.left)/s.object.zoom/o.clientWidth,s.object.matrix),_(t*(s.object.top-s.object.bottom)/s.object.zoom/o.clientHeight,s.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),s.enablePan=!1)});function P(e){s.object instanceof THREE.PerspectiveCamera?b/=e:s.object instanceof THREE.OrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom*e)),s.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function N(e){s.object instanceof THREE.PerspectiveCamera?b*=e:s.object instanceof THREE.OrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/e)),s.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function B(e){if(!1!==s.enabled){if(e.preventDefault(),e.button===s.mouseButtons.ORBIT){if(!1===s.enableRotate)return;t=e,v.set(t.clientX,t.clientY),h=d.ROTATE}else if(e.button===s.mouseButtons.ZOOM){if(!1===s.enableZoom)return;t=e,x.set(t.clientX,t.clientY),h=d.DOLLY}else if(e.button===s.mouseButtons.PAN){if(!1===s.enablePan)return;e=e,T.set(e.clientX,e.clientY),h=d.PAN}var t;h!==d.NONE&&(document.addEventListener("mousemove",D,!1),document.addEventListener("mouseup",F,!1),s.dispatchEvent(c))}}function D(e){var t;!1!==s.enabled&&(e.preventDefault(),h===d.ROTATE?!1!==s.enableRotate&&(t=e,g.set(t.clientX,t.clientY),R.subVectors(g,v),t=s.domElement===document?s.domElement.body:s.domElement,V(2*Math.PI*R.x/t.clientWidth*s.rotateSpeed),j(2*Math.PI*R.y/t.clientHeight*s.rotateSpeed),v.copy(g),s.update()):h===d.DOLLY?!1!==s.enableZoom&&(t=e,M.set(t.clientX,t.clientY),S.subVectors(M,x),0<S.y?P(O()):S.y<0&&N(O()),x.copy(M),s.update()):h===d.PAN&&!1!==s.enablePan&&(e=e,w.set(e.clientX,e.clientY),H.subVectors(w,T),k(H.x,H.y),T.copy(w),s.update()))}function F(e){!1!==s.enabled&&(document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",F,!1),s.dispatchEvent(p),h=d.NONE)}function U(e){!1===s.enabled||!1===s.enableZoom||h!==d.NONE&&h!==d.ROTATE||(e.preventDefault(),e.stopPropagation(),(e=e).deltaY<0?N(O()):0<e.deltaY&&P(O()),s.update(),s.dispatchEvent(c),s.dispatchEvent(p))}function G(e){!1!==s.enabled&&!1!==s.enableKeys&&!1!==s.enablePan&&function(e){switch(e.keyCode){case s.keys.UP:k(0,s.keyPanSpeed),s.update();break;case s.keys.BOTTOM:k(0,-s.keyPanSpeed),s.update();break;case s.keys.LEFT:k(s.keyPanSpeed,0),s.update();break;case s.keys.RIGHT:k(-s.keyPanSpeed,0),s.update()}}(e)}function Z(e){if(!1!==s.enabled){switch(e.touches.length){case 1:if(!1===s.enableRotate)return;n=e,v.set(n.touches[0].pageX,n.touches[0].pageY),h=d.TOUCH_ROTATE;break;case 2:if(!1===s.enableZoom)return;n=(t=e).touches[0].pageX-t.touches[1].pageX,t=t.touches[0].pageY-t.touches[1].pageY,t=Math.sqrt(n*n+t*t),x.set(0,t),h=d.TOUCH_DOLLY;break;case 3:if(!1===s.enablePan)return;t=e,T.set(t.touches[0].pageX,t.touches[0].pageY),h=d.TOUCH_PAN;break;default:h=d.NONE}var t,n;h!==d.NONE&&s.dispatchEvent(c)}}function I(e){var t,n;if(!1!==s.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===s.enableRotate)return;if(h!==d.TOUCH_ROTATE)return;n=e,g.set(n.touches[0].pageX,n.touches[0].pageY),R.subVectors(g,v),n=s.domElement===document?s.domElement.body:s.domElement,V(2*Math.PI*R.x/n.clientWidth*s.rotateSpeed),j(2*Math.PI*R.y/n.clientHeight*s.rotateSpeed),v.copy(g),s.update();break;case 2:if(!1===s.enableZoom)return;if(h!==d.TOUCH_DOLLY)return;n=(t=e).touches[0].pageX-t.touches[1].pageX,t=t.touches[0].pageY-t.touches[1].pageY,t=Math.sqrt(n*n+t*t),M.set(0,t),S.subVectors(M,x),0<S.y?N(O()):S.y<0&&P(O()),x.copy(M),s.update();break;case 3:if(!1===s.enablePan)return;if(h!==d.TOUCH_PAN)return;t=e,w.set(t.touches[0].pageX,t.touches[0].pageY),H.subVectors(w,T),k(H.x,H.y),T.copy(w),s.update();break;default:h=d.NONE}}function W(e){!1!==s.enabled&&(s.dispatchEvent(p),h=d.NONE)}function Y(e){e.preventDefault()}s.domElement.addEventListener("contextmenu",Y,!1),s.domElement.addEventListener("mousedown",B,!1),s.domElement.addEventListener("wheel",U,!1),s.domElement.addEventListener("touchstart",Z,!1),s.domElement.addEventListener("touchend",W,!1),s.domElement.addEventListener("touchmove",I,!1),window.addEventListener("keydown",G,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}}),THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var ie,re,i,ae,se,le,ce,pe,de,he,Ee,ue=[],me=0,be=[],t=0,n=[],o=0,r=[],a=0,fe=[],ye=0,ve={objects:[],lights:[],elements:[]},ge=new THREE.Vector3,Re=new THREE.Vector4,s=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),m=new THREE.Box3,b=new Array(3),Te=(new Array(4),new THREE.Matrix4),we=new THREE.Matrix4,He=new THREE.Matrix4,xe=new THREE.Matrix3,Me=new THREE.Frustum,Se=new THREE.Vector4,Oe=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var Ve=new function(){var l=[],c=[],p=null,d=null,h=new THREE.Matrix3;function o(e){var t=e.position,n=e.positionWorld,o=e.positionScreen;n.copy(t).applyMatrix4(Ee),o.copy(n).applyMatrix4(we);n=1/o.w;o.x*=n,o.y*=n,o.z*=n,e.visible=-1<=o.x&&o.x<=1&&-1<=o.y&&o.y<=1&&-1<=o.z&&o.z<=1}function E(e,t,n){return!0===e.visible||!0===t.visible||!0===n.visible||(b[0]=e.positionScreen,b[1]=t.positionScreen,b[2]=n.positionScreen,s.intersectsBox(m.setFromPoints(b)))}function u(e,t,n){return(n.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(n.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){d=(p=e).material,h.getNormalMatrix(p.matrixWorld),l.length=0,c.length=0},projectVertex:o,checkTriangleVisibility:E,checkBackfaceCulling:u,pushVertex:function(e,t,n){(i=je()).position.set(e,t,n),o(i)},pushNormal:function(e,t,n){l.push(e,t,n)},pushUv:function(e,t){c.push(e,t)},pushLine:function(e,t){e=be[e],t=be[t],(ce=Le()).id=p.id,ce.v1.copy(e),ce.v2.copy(t),ce.z=(e.positionScreen.z+t.positionScreen.z)/2,ce.renderOrder=p.renderOrder,ce.material=p.material,ve.elements.push(ce)},pushTriangle:function(e,t,n){var o=be[e],i=be[t],r=be[n];if(!1!==E(o,i,r)&&(d.side===THREE.DoubleSide||!0===u(o,i,r))){(se=Ce()).id=p.id,se.v1.copy(o),se.v2.copy(i),se.v3.copy(r),se.z=(o.positionScreen.z+i.positionScreen.z+r.positionScreen.z)/3,se.renderOrder=p.renderOrder,se.normalModel.fromArray(l,3*e),se.normalModel.applyMatrix3(h).normalize();for(var a=0;a<3;a++){var s=se.vertexNormalsModel[a];s.fromArray(l,3*arguments[a]),s.applyMatrix3(h).normalize(),se.uvs[a].fromArray(c,2*arguments[a])}se.vertexNormalsLength=3,se.material=p.material,ve.elements.push(se)}}}};function je(){if(ae!==t)return be[ae++];var e=new THREE.RenderableVertex;return be.push(e),t++,ae++,e}function Ce(){if(le!==o)return n[le++];var e=new THREE.RenderableFace;return n.push(e),o++,le++,e}function Le(){if(pe!==a)return r[pe++];var e=new THREE.RenderableLine;return r.push(e),a++,pe++,e}function ze(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}this.projectScene=function(e,t,n,o){function i(e){(ie=function(){if(re!==me)return ue[re++];var e=new THREE.RenderableObject;return ue.push(e),me++,re++,e}()).id=e.id,ie.object=e,ge.setFromMatrixPosition(e.matrixWorld),ge.applyMatrix4(we),ie.z=ge.z,ie.renderOrder=e.renderOrder,ve.objects.push(ie)}he=pe=le=0,!(ve.elements.length=0)===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),Te.copy(t.matrixWorldInverse.getInverse(t.matrixWorld)),we.multiplyMatrices(t.projectionMatrix,Te),Me.setFromMatrix(we),re=0,ve.objects.length=0,ve.lights.length=0,e.traverseVisible(function(e){e instanceof THREE.Light?ve.lights.push(e):e instanceof THREE.Mesh||e instanceof THREE.Line?!1!==e.material.visible&&(!0===e.frustumCulled&&!1===Me.intersectsObject(e)||i(e)):e instanceof THREE.Sprite&&!1!==e.material.visible&&(!0===e.frustumCulled&&!1===Me.intersectsSprite(e)||i(e))}),!0===n&&ve.objects.sort(ze);for(var r,a,s,l,c,p,d,h,E=0,u=ve.objects.length;E<u;E++){var m,b=ve.objects[E].object,f=b.geometry;if(Ve.setObject(b),Ee=b.matrixWorld,ae=0,b instanceof THREE.Mesh){if(f instanceof THREE.BufferGeometry){var y=f.attributes,v=f.groups;if(void 0!==y.position){for(var g=0,R=(ne=y.position.array).length;g<R;g+=3)Ve.pushVertex(ne[g],ne[g+1],ne[g+2]);if(void 0!==y.normal)for(var T=y.normal.array,g=0,R=T.length;g<R;g+=3)Ve.pushNormal(T[g],T[g+1],T[g+2]);if(void 0!==y.uv)for(var w=y.uv.array,g=0,R=w.length;g<R;g+=2)Ve.pushUv(w[g],w[g+1]);if(null!==f.index){var H=f.index.array;if(0<v.length)for(var x=0;x<v.length;x++)for(var M=v[x],g=M.start,R=M.start+M.count;g<R;g+=3)Ve.pushTriangle(H[g],H[g+1],H[g+2]);else for(g=0,R=H.length;g<R;g+=3)Ve.pushTriangle(H[g],H[g+1],H[g+2])}else for(g=0,R=ne.length/3;g<R;g+=3)Ve.pushTriangle(g,g+1,g+2)}}else if(f instanceof THREE.Geometry){var S=f.vertices,O=f.faces,V=f.faceVertexUvs[0];xe.getNormalMatrix(Ee);for(var j=(G=b.material)instanceof THREE.MultiMaterial,C=!0==j?b.material:null,L=0,z=S.length;L<z;L++){var A=S[L];if(ge.copy(A),!0===G.morphTargets)for(var _=f.morphTargets,k=b.morphTargetInfluences,P=0,N=_.length;P<N;P++){var B,D=k[P];0!==D&&(B=_[P].vertices[L],ge.x+=(B.x-A.x)*D,ge.y+=(B.y-A.y)*D,ge.z+=(B.z-A.z)*D)}Ve.pushVertex(ge.x,ge.y,ge.z)}for(var F=0,U=O.length;F<U;F++){var G,Z=O[F];if(void 0!==(G=!0==j?C.materials[Z.materialIndex]:b.material)){var I=G.side,W=be[Z.a],Y=be[Z.b],X=be[Z.c];if(!1!==Ve.checkTriangleVisibility(W,Y,X)){var q=Ve.checkBackfaceCulling(W,Y,X);if(I!==THREE.DoubleSide){if(I===THREE.FrontSide&&!1===q)continue;if(I===THREE.BackSide&&!0===q)continue}(se=Ce()).id=b.id,se.v1.copy(W),se.v2.copy(Y),se.v3.copy(X),se.normalModel.copy(Z.normal),!1!==q||I!==THREE.BackSide&&I!==THREE.DoubleSide||se.normalModel.negate(),se.normalModel.applyMatrix3(xe).normalize();for(var K=Z.vertexNormals,Q=0,J=Math.min(K.length,3);Q<J;Q++){var $=se.vertexNormalsModel[Q];$.copy(K[Q]),!1!==q||I!==THREE.BackSide&&I!==THREE.DoubleSide||$.negate(),$.applyMatrix3(xe).normalize()}se.vertexNormalsLength=K.length;var ee=V[F];if(void 0!==ee)for(var te=0;te<3;te++)se.uvs[te].copy(ee[te]);se.color=Z.color,se.material=G,se.z=(W.positionScreen.z+Y.positionScreen.z+X.positionScreen.z)/3,se.renderOrder=b.renderOrder,ve.elements.push(se)}}}}}else if(b instanceof THREE.Line){if(f instanceof THREE.BufferGeometry){if(void 0!==(y=f.attributes).position){for(var ne,g=0,R=(ne=y.position.array).length;g<R;g+=3)Ve.pushVertex(ne[g],ne[g+1],ne[g+2]);if(null!==f.index)for(g=0,R=(H=f.index.array).length;g<R;g+=2)Ve.pushLine(H[g],H[g+1]);else for(var oe=b instanceof THREE.LineSegments?2:1,g=0,R=ne.length/3-1;g<R;g+=oe)Ve.pushLine(g,g+1)}}else if(f instanceof THREE.Geometry)if(He.multiplyMatrices(we,Ee),0!==(S=b.geometry.vertices).length){(W=je()).positionScreen.copy(S[0]).applyMatrix4(He);for(oe=b instanceof THREE.LineSegments?2:1,L=1,z=S.length;L<z;L++)(W=je()).positionScreen.copy(S[L]).applyMatrix4(He),0<(L+1)%oe||(Y=be[ae-2],Se.copy(W.positionScreen),Oe.copy(Y.positionScreen),!0==(a=Oe,h=d=p=c=l=s=void 0,s=0,l=1,c=(r=Se).z+r.w,p=a.z+a.w,d=-r.z+r.w,h=-a.z+a.w,0<=c&&0<=p&&0<=d&&0<=h||!(c<0&&p<0||d<0&&h<0)&&(c<0?s=Math.max(s,c/(c-p)):p<0&&(l=Math.min(l,c/(c-p))),d<0?s=Math.max(s,d/(d-h)):h<0&&(l=Math.min(l,d/(d-h))),!(l<s)&&(r.lerp(a,s),a.lerp(r,1-l),!0)))&&(Se.multiplyScalar(1/Se.w),Oe.multiplyScalar(1/Oe.w),(ce=Le()).id=b.id,ce.v1.positionScreen.copy(Se),ce.v2.positionScreen.copy(Oe),ce.z=Math.max(Se.z,Oe.z),ce.renderOrder=b.renderOrder,ce.material=b.material,b.material.vertexColors===THREE.VertexColors&&(ce.vertexColors[0].copy(b.geometry.colors[L]),ce.vertexColors[1].copy(b.geometry.colors[L-1])),ve.elements.push(ce)))}}else b instanceof THREE.Sprite&&(Re.set(Ee.elements[12],Ee.elements[13],Ee.elements[14],1),Re.applyMatrix4(we),m=1/Re.w,Re.z*=m,-1<=Re.z&&Re.z<=1&&((de=function(){if(he!==ye)return fe[he++];var e=new THREE.RenderableSprite;return fe.push(e),ye++,he++,e}()).id=b.id,de.x=Re.x*m,de.y=Re.y*m,de.z=Re.z,de.renderOrder=b.renderOrder,de.object=b,de.rotation=b.rotation,de.scale.x=b.scale.x*Math.abs(de.x-(Re.x+t.projectionMatrix.elements[0])/(Re.w+t.projectionMatrix.elements[12])),de.scale.y=b.scale.y*Math.abs(de.y-(Re.y+t.projectionMatrix.elements[5])/(Re.w+t.projectionMatrix.elements[13])),de.material=b.material,ve.elements.push(de)))}return!0===o&&ve.elements.sort(ze),ve}},THREE.SVGObject=function(e){THREE.Object3D.call(this),this.node=e},THREE.SVGObject.prototype=Object.create(THREE.Object3D.prototype),THREE.SVGObject.prototype.constructor=THREE.SVGObject,THREE.SVGRenderer=function(){console.log("THREE.SVGRenderer",THREE.REVISION);var p,d,h,n,o,E,u,m,b,f,y,v=this,g=new THREE.Projector,R=document.createElementNS("http://www.w3.org/2000/svg","svg"),T=new THREE.Box2,w=new THREE.Box2,H=new THREE.Color,x=new THREE.Color,M=new THREE.Color,S=new THREE.Color,O=new THREE.Color,i=new THREE.Color,r=1,V=new THREE.Vector3,j=new THREE.Vector3,C=new THREE.Vector3,L=new THREE.Matrix3,z=new THREE.Matrix4,A=new THREE.Matrix4,_=[],k=[],P=[],N=0,B=0,D=0,F=1;function U(){for(D=B=N=0;0<R.childNodes.length;)R.removeChild(R.childNodes[0])}this.domElement=R,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.setQuality=function(e){switch(e){case"high":F=1;break;case"low":F=0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(e,t){i.set(e),r=void 0!==t?t:1},this.setPixelRatio=function(){},this.setSize=function(e,t){E=(n=e)/2,u=(o=t)/2,R.setAttribute("viewBox",-E+" "+-u+" "+n+" "+o),R.setAttribute("width",n),R.setAttribute("height",o),T.min.set(-E,-u),T.max.set(E,u)},this.clear=function(){U(),R.style.backgroundColor="rgba("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+","+r+")"},this.render=function(e,t){if(t instanceof THREE.Camera!=!1){var n=e.background;n&&n.isColor?(U(),R.style.backgroundColor="rgb("+Math.floor(255*n.r)+","+Math.floor(255*n.g)+","+Math.floor(255*n.b)+")"):!0===this.autoClear&&this.clear(),v.info.render.vertices=0,v.info.render.faces=0,z.copy(t.matrixWorldInverse.getInverse(t.matrixWorld)),A.multiplyMatrices(t.projectionMatrix,z),p=g.projectScene(e,t,this.sortObjects,this.sortElements),d=p.elements,h=p.lights,L.getNormalMatrix(t.matrixWorldInverse),function(e){M.setRGB(0,0,0),S.setRGB(0,0,0),O.setRGB(0,0,0);for(var t=0,n=e.length;t<n;t++){var o=e[t],i=o.color;o instanceof THREE.AmbientLight?(M.r+=i.r,M.g+=i.g,M.b+=i.b):o instanceof THREE.DirectionalLight?(S.r+=i.r,S.g+=i.g,S.b+=i.b):o instanceof THREE.PointLight&&(O.r+=i.r,O.g+=i.g,O.b+=i.b)}}(h);for(var o,i,r,a=0,s=d.length;a<s;a++){var l=d[a],c=l.material;void 0!==c&&0!==c.opacity&&(w.makeEmpty(),l instanceof THREE.RenderableSprite?((m=l).x*=E,m.y*=-u,function(e,t,n){var o=t.scale.x*E,t=t.scale.y*u;(y=function(e){if(null!=P[e])return P[e];P[e]=document.createElementNS("http://www.w3.org/2000/svg","rect"),0==F&&P[e].setAttribute("shape-rendering","crispEdges");return P[e]}(D++)).setAttribute("x",e.x-.5*o),y.setAttribute("y",e.y-.5*t),y.setAttribute("width",o),y.setAttribute("height",t),n instanceof THREE.SpriteMaterial&&y.setAttribute("style","fill: "+n.color.getStyle());R.appendChild(y)}(m,l,c)):l instanceof THREE.RenderableLine?(m=l.v1,b=l.v2,m.positionScreen.x*=E,m.positionScreen.y*=-u,b.positionScreen.x*=E,b.positionScreen.y*=-u,w.setFromPoints([m.positionScreen,b.positionScreen]),!0===T.intersectsBox(w)&&(o=m,i=b,r=c,(y=function(e){if(null!=k[e])return k[e];k[e]=document.createElementNS("http://www.w3.org/2000/svg","line"),0==F&&k[e].setAttribute("shape-rendering","crispEdges");return k[e]}(B++)).setAttribute("x1",o.positionScreen.x),y.setAttribute("y1",o.positionScreen.y),y.setAttribute("x2",i.positionScreen.x),y.setAttribute("y2",i.positionScreen.y),r instanceof THREE.LineBasicMaterial&&(y.setAttribute("style","fill: none; stroke: "+r.color.getStyle()+"; stroke-width: "+r.linewidth+"; stroke-opacity: "+r.opacity+"; stroke-linecap: "+r.linecap+"; stroke-linejoin: "+r.linejoin),R.appendChild(y)))):l instanceof THREE.RenderableFace&&(m=l.v1,b=l.v2,f=l.v3,m.positionScreen.z<-1||1<m.positionScreen.z||b.positionScreen.z<-1||1<b.positionScreen.z||f.positionScreen.z<-1||1<f.positionScreen.z||(m.positionScreen.x*=E,m.positionScreen.y*=-u,b.positionScreen.x*=E,b.positionScreen.y*=-u,f.positionScreen.x*=E,f.positionScreen.y*=-u,w.setFromPoints([m.positionScreen,b.positionScreen,f.positionScreen]),!0===T.intersectsBox(w)&&function(e,t,n,o,i){v.info.render.vertices+=3,v.info.render.faces++,(y=function(e){if(null!=_[e])return _[e];_[e]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==F&&_[e].setAttribute("shape-rendering","crispEdges");return _[e]}(N++)).setAttribute("d","M "+e.positionScreen.x+" "+e.positionScreen.y+" L "+t.positionScreen.x+" "+t.positionScreen.y+" L "+n.positionScreen.x+","+n.positionScreen.y+"z"),i instanceof THREE.MeshBasicMaterial?(H.copy(i.color),i.vertexColors===THREE.FaceColors&&H.multiply(o.color)):i instanceof THREE.MeshLambertMaterial||i instanceof THREE.MeshPhongMaterial?(x.copy(i.color),i.vertexColors===THREE.FaceColors&&x.multiply(o.color),H.copy(M),j.copy(e.positionWorld).add(t.positionWorld).add(n.positionWorld).divideScalar(3),function(e,t,n,o){for(var i=0,r=e.length;i<r;i++){var a,s,l=e[i],c=l.color;l instanceof THREE.DirectionalLight?(a=V.setFromMatrixPosition(l.matrixWorld).normalize(),(s=n.dot(a))<=0||(s*=l.intensity,o.r+=c.r*s,o.g+=c.g*s,o.b+=c.b*s)):l instanceof THREE.PointLight&&(a=V.setFromMatrixPosition(l.matrixWorld),(s=n.dot(V.subVectors(a,t).normalize()))<=0||0!=(s*=0==l.distance?1:1-Math.min(t.distanceTo(a)/l.distance,1))&&(s*=l.intensity,o.r+=c.r*s,o.g+=c.g*s,o.b+=c.b*s))}}(h,j,o.normalModel,H),H.multiply(x).add(i.emissive)):i instanceof THREE.MeshNormalMaterial&&(C.copy(o.normalModel).applyMatrix3(L),H.setRGB(C.x,C.y,C.z).multiplyScalar(.5).addScalar(.5));i.wireframe?y.setAttribute("style","fill: none; stroke: "+H.getStyle()+"; stroke-width: "+i.wireframeLinewidth+"; stroke-opacity: "+i.opacity+"; stroke-linecap: "+i.wireframeLinecap+"; stroke-linejoin: "+i.wireframeLinejoin):y.setAttribute("style","fill: "+H.getStyle()+"; fill-opacity: "+i.opacity);R.appendChild(y)}(m,b,f,l,c))))}e.traverseVisible(function(e){var t,n;e instanceof THREE.SVGObject&&(V.setFromMatrixPosition(e.matrixWorld),V.applyMatrix4(A),t=V.x*E,n=-V.y*u,(e=e.node).setAttribute("transform","translate("+t+","+n+")"),R.appendChild(e))})}else console.error("THREE.SVGRenderer.render: camera is not an instance of THREE.Camera.")}};var THREE=require("three/build/three.module"),prettifyLabel=function(e,t){return t=void 0!==t&&t,e=(e=(e=(e=(e=e.replace(/GAMMA/gi,"&Gamma;")).replace(/DELTA/gi,"&Delta;")).replace(/SIGMA/gi,"&Sigma;")).replace(/LAMBDA/gi,"&Lambda;")).replace(/\-/gi,"&mdash;"),e=t?e.replace(/_(.)/gi,function(e,t,n,o){return'<tspan baseline-shift="sub">'+t+"</tspan>"}):e.replace(/_(.)/gi,function(e,t,n,o){return"<sub>"+t+"</sub>"})},BZVisualizer=function(u,m,f,y){u=void 0===u||u,m=void 0===m||m,f=void 0!==f&&f,y=void 0!==y&&y;var v=[],g=new THREE.MeshBasicMaterial({color:13975119,opacity:.5,transparent:!0}),R=new THREE.LineBasicMaterial({color:3355443,opacity:1,transparent:!1,linewidth:1}),T=new THREE.LineBasicMaterial({color:285405,opacity:1,transparent:!1}),w=new THREE.MeshBasicMaterial({color:3311805,opacity:1,transparent:!1}),H=new THREE.MeshBasicMaterial({color:8925746,opacity:1,transparent:!1}),x=null,M=null,S=null,O=null;this.loadBZAjax=function(e,t,o){document.getElementById(o).innerHTML="Loading...",$.getJSON(newpath_to_load,function(e){loadBZ(t,o,e)}).fail(function(e,t,n){n=t+", "+n;console.log("Request Failed: "+n),document.getElementById(o).innerHTML="Request Failed: "+n})},this.resizeRenderer=function(){var e,t;O&&(e=document.getElementById(O),t=window.devicePixelRatio||1,canvas3d_width=e.offsetWidth,canvas3d_height=e.offsetHeight,S&&(M.aspect=canvas3d_width/canvas3d_height,M.updateProjectionMatrix(),S.setSize(canvas3d_width*t,canvas3d_height*t),S.domElement.style.width=canvas3d_width+"px",S.domElement.style.height=canvas3d_height+"px",S.domElement.width=canvas3d_width*t,S.domElement.height=canvas3d_height*t),j())};var V=function(e,t){var n,o;return t=void 0!==t?t:"#000000",y?((o=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("y",-100),o.setAttribute("x",-100),o.setAttribute("font-family","'Helvetica Neue', Helvetica, Arial, sans-serif"),n=window.devicePixelRatio||1,o.setAttribute("font-size",12*n+"px"),o.setAttribute("fill",t),o.innerHTML=e):((o=document.createElement("div")).style.position="absolute",o.style.fontFamily="'Helvetica Neue', Helvetica, Arial, sans-serif",o.style.color=t,o.style.width=100,o.style.height=100,o.style.fontSize="12px",o.innerHTML=e,o.style.top="-100px",o.style.left="-100px",o.style.userSelect="none",o.style.userSelect="none",o.style.webkitUserSelect="none",o.style.MozUserSelect="none",o.setAttribute("unselectable","on"),o.style.pointerEvents="none"),o};function n(e,t){var n,o,e=e.clone().project(t),t=window.devicePixelRatio||1;return y?(n=.5*S.domElement.viewBox.baseVal.width,o=.5*S.domElement.viewBox.baseVal.height,S.domElement.viewBox.baseVal.x,S.domElement.viewBox.baseVal.y,e.x=e.x*n,e.y=-e.y*o):(n=.5*S.getContext().canvas.width/t,o=.5*S.getContext().canvas.height/t,e.x=e.x*n+n,e.y=-e.y*o+o),{left:e.x,top:e.y}}function j(){S.render(x,M),y?v.forEach(function(e){pos=e[0],textcontent=e[1],t=2<e.length?(the_color=e[2],V(textcontent,the_color)):V(textcontent),pos2d=n(pos,M),t.setAttribute("y",pos2d.top),t.setAttribute("x",pos2d.left),S.domElement.appendChild(t)}):v.forEach(function(e){pos=e[0],text=e[1],pos2d=n(pos,M),text.style.top=pos2d.top+"px",text.style.left=pos2d.left+"px"})}this.loadBZ=function(e,t,n){O=e;var o=document.getElementById(e),e=window.devicePixelRatio||1;for(document.getElementById(t).innerHTML="";o.firstChild;)o.removeChild(o.firstChild);v=[],x=new THREE.Scene,canvas3d_width=o.offsetWidth,canvas3d_height=o.offsetHeight,(M=new THREE.PerspectiveCamera(45,canvas3d_width/canvas3d_height,.01,1e3)).position.z=3,y?(S=new THREE.SVGRenderer).setQuality("high"):S=new THREE.WebGLRenderer({alpha:!0,preserveDrawingBuffer:!0}),S.setClearColor(16777215,0),S.setSize(canvas3d_width*e,canvas3d_height*e),S.domElement.style.width=canvas3d_width+"px",S.domElement.style.height=canvas3d_height+"px",S.domElement.width=canvas3d_width*e,S.domElement.height=canvas3d_height*e,o.appendChild(S.domElement),controls=new THREE.OrbitControls(M,S.domElement),controls.addEventListener("change",j),controls.enableDamping=!0,controls.dampingFactor=.25,controls.enableZoom=!0,special_points=n.kpoints,b1=n.b1,b2=n.b2,b3=n.b3,max_b_length=Math.sqrt(Math.max(Math.pow(b1[0],2)+Math.pow(b1[1],2)+Math.pow(b1[2],2),Math.pow(b2[0],2)+Math.pow(b2[1],2)+Math.pow(b2[2],2),Math.pow(b3[0],2)+Math.pow(b3[1],2)+Math.pow(b3[2],2)));var i=1.5*max_b_length;for(a in M.position.z=3*max_b_length,data=n.faces_data,special_points){pos=special_points[a],radius=.02*max_b_length;var r=new THREE.SphereGeometry(radius,16,16);(p=new THREE.Mesh(r,w)).translateX(pos[0]),p.translateY(pos[1]),p.translateZ(pos[2]),x.add(p);var a=prettifyLabel(a,forSVG=y),s=V(a);y?(S.domElement.appendChild(s),v.push([new THREE.Vector3(pos[0],pos[1],pos[2]),a])):(o.appendChild(s),v.push([new THREE.Vector3(pos[0],pos[1],pos[2]),s]))}u&&(axesLabels=[[new THREE.Vector3(1,0,0),'<span style="font-style: italic">x</span>'],[new THREE.Vector3(0,1,0),'<span style="font-style: italic">y</span>'],[new THREE.Vector3(0,0,1),'<span style="font-style: italic">z</span>']],y&&(axesLabels=[[new THREE.Vector3(1,0,0),'<tspan style="font-style: italic">x</tspan>'],[new THREE.Vector3(0,1,0),'<tspan style="font-style: italic">y</tspan>'],[new THREE.Vector3(0,0,1),'<tspan style="font-style: italic">z</tspan>']]),axesLabels.forEach(function(e){dir=e[0],a=e[1];var t=new THREE.Vector3(0,0,0),e=new THREE.ArrowHelper(dir,t,i,5592405,headLength=i/10,headwidth=i/20);x.add(e),the_color="#555555",s=V(a,color=the_color),pos=dir.clone(),pos.sub(t),pos.multiplyScalar(i),y?(S.domElement.appendChild(s),v.push([pos,a,the_color])):(o.appendChild(s),v.push([pos,s]))}));t=[[b1,'<span style="font-weight: bold">b</span><sub>1</sub>'],[b2,'<span style="font-weight: bold">b</span><sub>2</sub>'],[b3,'<span style="font-weight: bold">b</span><sub>3</sub>']];y&&(t=[[b1,'<tspan style="font-weight: bold">b</tspan><tspan baseline-shift="sub">1</tspan>'],[b2,'<tspan style="font-weight: bold">b</tspan><tspan baseline-shift="sub">2</tspan>'],[b3,'<tspan style="font-weight: bold">b</tspan><tspan baseline-shift="sub">3</tspan>']]),(t=!m?[]:t).forEach(function(e){b=e[0],a=e[1],b_length=Math.sqrt(Math.pow(b[0],2)+Math.pow(b[1],2)+Math.pow(b[2],2)),dir=new THREE.Vector3(b[0]/b_length,b[1]/b_length,b[2]/b_length);var t=new THREE.Vector3(0,0,0),e=new THREE.ArrowHelper(dir,t,length=b_length,0,headLength=b_length/10,headwidth=b_length/20);x.add(e);e=V(a);pos=dir.clone(),pos.sub(t),pos.multiplyScalar(b_length),y?(S.domElement.appendChild(e),v.push([pos,a])):(o.appendChild(e),v.push([pos,e]))});var l=new THREE.Geometry;data.triangles_vertices.forEach(function(e){l.vertices.push(new THREE.Vector3(e[0],e[1],e[2]))}),data.triangles.forEach(function(e){l.faces.push(new THREE.Face3(e[0],e[1],e[2]))});e=new THREE.Mesh(l,g);geometry=new THREE.EdgesGeometry(e.geometry);t=new THREE.LineSegments(geometry,R);if(x.add(e),x.add(t),path=n.path,path.forEach(function(e){label1=e[0],label2=e[1],p1=special_points[label1],p2=special_points[label2];e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(p1[0],p1[1],p1[2])),e.vertices.push(new THREE.Vector3(p2[0],p2[1],p2[2]));e=new THREE.Line(e,T);e.material.linewidth=4,e.name="pathvectors",x.add(e)}),this.update_pathVector=function(e){for(var t=x.getObjectByName("pathvectors");t;)t=x.getObjectByName("pathvectors"),x.remove(t);e.forEach(function(e){label1=e[0],label2=e[1],p1=special_points[label1],p2=special_points[label2];e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(p1[0],p1[1],p1[2])),e.vertices.push(new THREE.Vector3(p2[0],p2[1],p2[2]));e=new THREE.Line(e,T);e.material.linewidth=4,e.name="pathvectors",x.add(e)}),j()},f)for(var c in kpoints_abs=n.explicit_kpoints_abs,kpoints_abs){pos=kpoints_abs[c],radius=.005*max_b_length;var p,r=new THREE.SphereGeometry(radius,16,16);(p=new THREE.Mesh(r,H)).translateX(pos[0]),p.translateY(pos[1]),p.translateZ(pos[2]),p.name="kpts",x.add(p)}j();function d(e,t){t=void 0===t?!controls.enabled:t,controls.enabled=t,elems=o.getElementsByClassName("BZDoubleClickText");for(var n=0;n<elems.length;n++)o.removeChild(elems[n]);t||o.appendChild(function(e){var t=document.createElement("div");t.classList.add(e),t.style.position="absolute",t.style.fontFamily="'Helvetica Neue', Helvetica, Arial, sans-serif",t.style.zIndex=1,t.style.width="100%",t.style.height="100%",t.style.display="table",t.style.top="0px",t.style.left="0px",t.style.textAlign="center",t.style.verticalAlign="middle",t.style.userSelect="none",t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.MozUserSelect="none",t.setAttribute("unselectable","on");e=document.createElement("span");return e.innerHTML="Double click to toggle interaction",e.style.color="rgb(80, 80, 80)",e.style.fontSize="24px",e.style.fontWeight="bold",e.style.backgroundColor="rgba(230,230,230,0.5)",e.style.display="table-cell",e.style.verticalAlign="middle",e.style.lineHeight="normal",e.style.userSelect="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.MozUserSelect="none",e.setAttribute("unselectable","on"),e.onmouseover=function(){this.style.backgroundColor="rgba(230,230,230,0.5)",this.innerHTML="Double click to toggle interaction"},e.onmouseleave=function(){this.style.backgroundColor="rgba(255,255,255,0.01)",this.innerHTML=""},t.appendChild(e),t}("BZDoubleClickText"))}var h;d(force_status=!1),o.addEventListener("dblclick",d),toggle_visibility=function(e){0===g.opacity?g.opacity=.3:g.opacity=0,g.needsUpdate=!0,j()},this.set_visibility=function(e){g.opacity=e?.3:0,g.needsUpdate=!0,j()};var E=!(this.update_kpts=function(e){for(var t,n=x.getObjectByName("kpts");n;)n=x.getObjectByName("kpts"),x.remove(n);for(t in e){pos=e[t],radius=.008*max_b_length;var o=new THREE.SphereGeometry(radius,16,16),o=new THREE.Mesh(o,H);o.translateX(pos[0]),o.translateY(pos[1]),o.translateZ(pos[2]),o.name="kpts",x.add(o)}j()});o.addEventListener("touchend",function(e){void 0!==h&&clearTimeout(h),E?(E=!1,e.preventDefault(),d()):0==e.targetTouches.length?(E=!0,h=setTimeout(function(){E=!1},500)):void 0!==h&&(clearTimeout(h),E=!1)}),o.addEventListener("touchcancel",function(e){void 0!==h&&(clearTimeout(h),E=!1)}),o.addEventListener("touchmove",function(e){void 0!==h&&(clearTimeout(h),E=!1)})}};module.exports={BZVisualizer:BZVisualizer};